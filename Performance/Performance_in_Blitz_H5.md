# WebApp应用在Blitz中的优化

## 背景
在酷喵影视WebApp，酷喵少儿WebApp和桌面WebApp应用中所作的一些优化。

## 痛点
1. 瀑布流式展现大量图片运营内容，图片优雅加载，首屏展现加速；
2. 多机型适配，部分低配机型需要进行降级裁减，内存优化；
3. 动画体验不够流畅，不吸引用户；
4. 优化详情页加载；
5. CSS matching 的路径太长，效率低（Less写了太多层嵌套）

## 图片控制 （相关的优化策略）
1. 减少首屏请求图片个数
    - 对首屏外的图片进行lazy-load，最大限度保证首屏内的图片优先加载；（图片按需加载）
    - 对图片进行预加载
    - 合理使用sprite图片
    - inline image: 合理使用iconfont，base64，svg或者css3 代替部分图标
        >过渡使用base64编码图片会增加整个打包后js文件的大小，并发加载资源过多会阻塞js的加载

2. 减少图片大小，减少图片内存的占用
    - 通过cdn后添加width和height，根据运营坑位动态裁减图片
    - 强烈不推荐使用git图来实现帧动画效果，采用sprite图片实现
    - 约束运营使用jpg，页面中图片能用jpg尽量用jpg，而不用png，或者使用WebP,WebP支持无损透明度，也叫做alpha通道。
        > 因为png带有alpha通道，而jpg没有，所以使用jpg能提图片渲染性能。使用了png图片，如果确认没有透明度，可以在img标签src属性前添加noalpha，来让内核不去处理alpha通道，来提高性能。

3. jpg图片： 有损压缩
    png8: 256色 + 支持透明度
    png24: 2^24色 + 不支持透明
    png32: 2^24色 + 支持透明

4. jpg有损压缩，压缩率高，不支持透明
    png支持透明，浏览器兼容性好
    webp压缩程度更好，在ios webview有兼容性问题
    svg矢量图，代码内嵌，相对较小，图片样式相对简单的场景

5. webp  
    google 提出的图像数据压缩算法，能带来更小的图片体积，而且拥有肉眼识别的无差异图像质量；
    同时具备无损和有损的压缩模式，Alpha透明以及动画的特性，在JPEG和PNG上的转化效果都相当优秀，稳定和统一。
    Animated WebP  
    Webp 图片在ios的webview有兼容性问题，一般会先判断是否支持webp，进行一些兼容性或降级处理

6. 动图 gif, apng, awebp

## Loading阶段
1. 域名收敛
2. 减少或合并http请求数
3. 使用前端工程化工具（如webpack)进行文件优化，压缩和混淆
4. 缓存：

## 解决动画卡顿，优化动画性能，用户体验流畅度优化
1. 动画停止时图片加载
    - 页面中，图片加载是比较耗时的操作，尤其是图片数量很多时，容易造成动画性能瓶颈。在电视淘宝中，利用了blitz提供的stopImgLoading(停止图片加载)和resumeImgLoading(恢复图片加载)接口，在动画开始时马上把图片加载停止，等动画结束之后在恢复图片加载，这样能确保动画性能不被图片加载影响。

2. 采用防抖和节流函数优化短时间触发的大量事件操作
    限制resize和scroll等函数的调用频率

3. 减少回流与重绘的策略
    - 页面能使用绝对定位的地方，最好尽量使用绝对定位方式  (减少reflow)
    绝对定位的好处是，元素样式发生改变时，不影响其他元素的排版，能在页面重排时减少排版耗时。电视淘宝中的每个卡片位会频繁设置大小与位置，把卡片位样式设置成绝对定位方式，也会提高页面性能。
    - 使用CSS3 transform translate做属性动画

## 减少重绘与回流
1. 不能盲目采用各种策略，先使用chrome的Performance工具分析项目的性能瓶颈。
2. 

## 页面排版性能优化

1. 尽量减少dom节点数量
    比如电视淘宝的拉绳子动画，在电视淘宝中卡片位的dom节点是循环利用的，卡片位移出屏幕之后，会重新被即将出现到屏幕中的卡片位节点使用。像类似于电视淘宝中的每个卡片位里面的dom节点数量超过10个的情况，这种方式能显著减少节点数量。

2. 页面能使用绝对定位的地方，最好尽量使用绝对定位方式
    绝对定位的好处是，元素样式发生改变时，不影响其他元素的排版，能在页面重排时减少排版耗时。电视淘宝中的每个卡片位会频繁设置大小与位置，把卡片位样式设置成绝对定位方式，也会提高页面性能。

3. 尽量减少dom节点增删操作。
    - dom节点的增删操作比较耗时，而且节点的改变也可能会引发页面的重排。比如电视淘宝中卡片位的循环利用，也能减少dom节点的增删操作。
    
4. 如果dom元素不在可见范围内，最好将其设置成display:none
    因为设置成display:none的节点，重排时该节点及其子节点不会被遍历到，相对能减少重排时间。

## JS优化
1. 降低函数调用层次

   有些js框架封装比较多，或者使用很多闭包，这样会降低JS的执行效率，同时闭包也可能导致不必要的对象被引用，增加js对象的数量，影响gc性能。在影响可能影响动画性能的地方，可以针对这些情况做优化。比如之前做拉绳子动画效果时，所用的框架从按键消息被接收到执行动画，会经历十几层函数调用，会耗费5ms左右的时间来响应，后面经过改进后，只需要两三层函数调用，响应时间也控制到了1ms之内
   
2. 优化耗时js操作
   
   一般来说，js中对dom节点的操作比较耗时，如果有多个dom节点操作，尽量合并js中dom节点操作，减少dom节点操作次数。另外需要注意的一点是，对使用的一些外部js库，性能要有所了解。因为有些库为了兼容，性能也行并不高，或者不适用与blitz。比如之前所用的zepto库，仅仅使用它来查找卡片位的某个子节点来设置样式，这样一个简单的JS操作，耗时居然要两三毫秒，十几个卡片位操作合计起来有时候要接近30毫秒，后来发现是zepto中通过选择器字符串来查找子节点的操作非常耗时，尝试几种改进方法后，最后用js原生接口操作，总共耗时也才两三毫秒。所以js性能较差时，需要通过测试来定位耗时操作，并多尝试几种方式，来找到最优方式。
   
3. 减少js对象数量
   
   js中有时使用的库或框架，会封装的比较重，new出来的对象会有很多属性，并引用了很多其他对象，这样js运行时会有大量js对象在内存中无法释放，造成内存占用较高，并影响gc性能，造成动画卡顿，这种时候可以尝试精简对象属性和数量，减少不必要的js对象数量。blitz中可以打开运行统计信息，可以实时看到js运行过程中的js对象数量，根据电视淘宝中拉绳子动画的经验，最好把js对象数量控制在3000以内。

4. 使用WebWorker

   Blitz现在已经支持了WebWorker，可以把有些耗时的操作放到worker中来运行


## 内存优化
   
1. 减少图片内存占用

   除了减少js对象数量之外，图片内存数量也需要注意。尤其是图片解压之后会占用内存较大，比如一个img标签，设置了图片地址之后，如果该图片不在可见区域内，可以把图片的地址设置成空字符串，这样图片节点还在，但是图片内存会被释放掉。这种情况可以根据不同应用场景来尝试优化。